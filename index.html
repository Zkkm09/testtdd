<!doctype html>

<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Where is it?</title>
<style>
:root{--bg:#071224;--text:#eef2ff;--muted:#9aa4c9;--accent:#38d39f}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--text);background:var(--bg);-webkit-font-smoothing:antialiased}
.app{min-height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px}
.center{display:flex;flex-direction:column;align-items:center;gap:18px}
h1.title{font-size:48px;margin:0;text-align:center}
.stage{width:100%;max-width:980px;display:flex;flex-direction:column;align-items:center;gap:18px}
.images{display:flex;gap:20px;justify-content:center;width:100%}
.card{width:45%;max-width:420px;aspect-ratio:4/3;border-radius:8px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#0b1a2a;cursor:pointer;position:relative;border:6px solid transparent;transition:border-color .18s ease,opacity .18s ease}
.card img{width:100%;height:100%;object-fit:cover;display:block}
.border-correct{border-color:#2ecc71}
.border-wrong{border-color:#e74c3c}
.hidden{display:none!important}
.big-you{font-size:120px;letter-spacing:6px}
.you-image{width:90%;max-width:1200px;transition:width .2s ease;display:block;border-radius:8px}
.ready-btn{background:var(--accent);color:#042226;border:none;padding:12px 22px;border-radius:10px;font-weight:700;font-size:18px;cursor:pointer}
.speaker-btn{background:transparent;border:2px solid rgba(255,255,255,.08);width:54px;height:54px;border-radius:999px;display:flex;align-items:center;justify-content:center;cursor:pointer}
.speaker-btn.active{border-color:var(--accent);box-shadow:0 6px 20px rgba(56,211,159,0.12)}
.loader-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#071224;z-index:9999;flex-direction:column;gap:18px}
.loader-dots{display:flex;gap:8px}
.dot{width:12px;height:12px;border-radius:50%;background:var(--muted);opacity:0.6;animation:blink 1s infinite}
@keyframes blink{0%{opacity:.2}50%{opacity:1}100%{opacity:.2}}
.question{font-size:48px;color:var(--text);text-align:center}
.fullscreen-video{position:fixed;left:0;right:0;top:0;bottom:0;background:black;display:flex;align-items:center;justify-content:center;z-index:9998}
.fullscreen-video video{width:100%;height:100%;object-fit:cover}
.footer-placeholder{height:40px}
@media (max-width:600px){
h1.title{font-size:32px}
.card{width:46%}
.big-you{font-size:72px}
}
.icon{width:22px;height:22px;display:block}
.row{display:flex;gap:12px;align-items:center}
.disabled{opacity:.45;pointer-events:none}
</style>
</head>
<body>
<div class="loader-screen" id="loader">
<div class="loader-dots">
<div class="dot" style="animation-delay:0s"></div>
<div class="dot" style="animation-delay:.15s"></div>
<div class="dot" style="animation-delay:.3s"></div>
</div>
<div class="row">
<button id="speakerBtn" class="speaker-btn" aria-label="Enable sound" title="Enable sound">
<svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
<path d="M11 5L6 9H2v6h4l5 4V5z" fill="#eef2ff"/>
<path id="waves" d="M19.5 8.5a6.5 6.5 0 010 7" stroke="#eef2ff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
</svg>
</button>
<button id="readyBtn" class="ready-btn disabled" disabled>Ready?</button>
</div>
</div>

<div class="app" id="app" style="display:none">
<div class="center">
<div class="stage" id="stage">
<div class="question" id="questionText"></div>
<div class="images" id="imagesRow">
<div class="card" id="imgLeft"><img id="leftImg" src=""></div>
<div class="card" id="imgRight"><img id="rightImg" src=""></div>
</div>
</div>
<div class="footer-placeholder"></div>
</div>
</div>

<div id="youScreen" class="center hidden" style="padding:20px">
<h1 class="big-you" id="youText">خطأ، انتِ!</h1>
<img id="youImage" class="you-image" src="">
</div>

<div id="videoContainer" class="fullscreen-video hidden">
<video id="mainVideo" playsinline webkit-playsinline muted></video>
</div>

<audio id="s1" src="sound1.mp3" preload="auto"></audio> <audio id="s2" src="sound2.mp3" preload="auto"></audio> <audio id="s3" src="sound3.mp3" preload="auto"></audio> <audio id="s4" src="sound4.mp3" preload="auto" loop></audio>
<audio id="emptySound" src="empty.mp3" preload="auto"></audio>

<script>
const assets = {
images:["tree1.jpg","tree2.jpg","icecream1.jpg","icecream2.jpg","moon1.jpg","moon2.jpg"],
sounds:["sound1.mp3","sound2.mp3","sound3.mp3","sound4.mp3"],
video:"video.mp4"
}
const loader = document.getElementById("loader")
const readyBtn = document.getElementById("readyBtn")
const speakerBtn = document.getElementById("speakerBtn")
const app = document.getElementById("app")
const questionText = document.getElementById("questionText")
const leftCard = document.getElementById("imgLeft")
const rightCard = document.getElementById("imgRight")
const leftImg = document.getElementById("leftImg")
const rightImg = document.getElementById("rightImg")
const s1 = document.getElementById("s1")
const s2 = document.getElementById("s2")
const s3 = document.getElementById("s3")
const s4 = document.getElementById("s4")
const youScreen = document.getElementById("youScreen")
const youImage = document.getElementById("youImage")
const youText = document.getElementById("youText")
const mainVideo = document.getElementById("mainVideo")
const videoContainer = document.getElementById("videoContainer")
const mainTitle = document.getElementById("mainTitle")

let loadedCount=0
let totalCount = assets.images.length + assets.sounds.length + 1
const preloadedImages = {}
let audioUnlocked = false

function markLoaded(){loadedCount++; if(loadedCount>=totalCount){readyBtn.classList.remove("disabled"); readyBtn.disabled=false}}

assets.images.forEach(src=>{
const i=new Image()
i.src=src
i.onload=()=>{preloadedImages[src]=i;markLoaded()}
i.onerror=()=>{preloadedImages[src]=i;markLoaded()}
})
assets.sounds.forEach(src=>{
const a=new Audio()
a.src=src
a.preload="auto"
a.oncanplaythrough=()=>{markLoaded()}
a.onerror=()=>{markLoaded()}
})
const vid = document.createElement("video")
vid.src=assets.video
vid.preload="auto"
vid.oncanplaythrough=()=>{markLoaded()}
vid.onerror=()=>{markLoaded()}

function unlockAudioGesture(){
  if(audioUnlocked) return;
  audioUnlocked = true;
  speakerBtn.classList.add("active");

  try{
    // Play only empty.mp3 silently to unlock audio
    emptySound.currentTime = 0;
    emptySound.play().then(()=> {
      // Audio is unlocked, do NOT play s1-s4 here
      console.log("Audio unlocked silently.");
    }).catch(()=>{});
  }catch(e){console.warn(e)}

  // Enable ready button
  readyBtn.classList.remove("disabled");
  readyBtn.disabled = false;
}


function stopAllSounds() {
  [s1, s2, s3].forEach(a => {
    try {
      a.pause();
      a.currentTime = 0;
    } catch(e){}
  });
}

const emptySound = document.getElementById("emptySound");

speakerBtn.addEventListener("click", () => {
  unlockAudioGesture(); // unlocks audio for future use
  // Play empty.mp3
  try { 
    emptySound.currentTime = 0; 
    emptySound.play().catch(()=>{}); 
  } catch(e){}
});





readyBtn.addEventListener("click",()=>{
if(!audioUnlocked) return
loader.style.display="none"
app.style.display="flex"
currentStep=0
showQuestion(0)
})

const steps = [
{q:"وين الشجرة؟",left:"tree1.jpg",right:"tree2.jpg",correct:"left",sound:s1},
{q:"وين الايس كريم؟",left:"icecream2.jpg",right:"icecream1.jpg",correct:"right",sound:s2},
{q:"وين القمر؟",left:"moon1.jpg",right:"moon2.jpg",correct:null,sound:s3}
]
let currentStep=0
let answered=false

function resetBorders(){leftCard.classList.remove("border-correct","border-wrong");rightCard.classList.remove("border-correct","border-wrong");leftCard.style.opacity=1;rightCard.style.opacity=1}
function showQuestion(idx){
  resetBorders()
  answered=false
  const step = steps[idx]
  questionText.textContent = step.q
  leftImg.src = step.left
  rightImg.src = step.right

  stopAllSounds(); // <- stop previous question sound
  try { step.sound.play().catch(()=>{}) } catch(e){}

  leftCard.onclick = ()=>handleClick("left")
  rightCard.onclick = ()=>handleClick("right")
}

function handleClick(choice){
if(answered) return
answered=true
const step = steps[currentStep]
if(currentStep<2){
if(step.correct===choice){
if(choice==="left"){leftCard.classList.add("border-correct");rightCard.classList.add("border-wrong")}
else{rightCard.classList.add("border-correct");leftCard.classList.add("border-wrong")}
setTimeout(()=>{currentStep++; if(currentStep<steps.length) showQuestion(currentStep); else proceedToYou()},800)
}else{
if(choice==="left"){leftCard.classList.add("border-wrong");rightCard.classList.add("border-correct")}
else{rightCard.classList.add("border-wrong");leftCard.classList.add("border-correct")}
setTimeout(()=>{currentStep++; if(currentStep<steps.length) showQuestion(currentStep); else proceedToYou()},800)
}}else{
  leftCard.classList.add("border-wrong")
  rightCard.classList.add("border-wrong")

  // Start sound4 immediately before flickering
  try {
    s3.pause(); 
    s3.currentTime = 0;

    s4.currentTime = 0;
    s4.muted = false;
    s4.play().catch(()=>{}); // <- starts playing immediately
  } catch(e){}

  startMoonFlicker(choice)
}


}
function startMoonFlicker(choice){
  // Stop s3, reset s4
  try {
    s3.pause();
    s3.currentTime = 0;
    s4.pause();
    s4.currentTime = 0;
    s4.playbackRate = 1;
    s4.muted = false;
    s4.play().catch(()=>{});
  } catch(e){}

  // Flicker parameters
  let cycles = 8;
  let durations = [500, 400, 300, 250, 200, 150, 100];
  let i = 0;

  function cycle(){
    if(i >= cycles){
      // After flicker, ensure s4 keeps playing
      try { s4.muted = false; s4.play().catch(()=>{}); } catch(e){}
      setTimeout(()=>{proceedToYou()}, 300);
      return;
    }

    if(i % 2 === 0){
      leftCard.style.opacity = 1;
      rightCard.style.opacity = 0;
    } else {
      leftCard.style.opacity = 0;
      rightCard.style.opacity = 1;
    }

    setTimeout(()=>{
      leftCard.style.opacity = 1;
      rightCard.style.opacity = 1;
      i++;
      cycle();
    }, durations[i]);
  }

  // Start flicker after a short delay to let s4 play
  setTimeout(()=>{ cycle(); }, 120);
}

function proceedToYou(){
leftCard.onclick=null
rightCard.onclick=null
app.style.display="none"
youImage.src = steps[2].left
youScreen.classList.remove("hidden")
youImage.style.width="90%"
setTimeout(()=>{youImage.style.width="100%";},50)
setTimeout(()=>{showVideoSequence()},800)
}
function showVideoSequence() {
  // Wait a bit so the YOU and image are fully shown first
  setTimeout(() => {
    // Fade out everything
    youScreen.style.transition = "opacity 0.6s ease";
    youScreen.style.opacity = "0";

    // After fade, hide and show video
    setTimeout(() => {
      youScreen.classList.add("hidden");
      app.style.display = "none";
      loader.style.display = "none";

      videoContainer.classList.remove("hidden");
      mainVideo.src = "video.mp4";
      mainVideo.setAttribute("playsinline", "");
      mainVideo.setAttribute("webkit-playsinline", "");
      mainVideo.muted = true;
      mainVideo.loop = true;
      mainVideo.play().catch(() => {});


      // continue looping sound4 if desired
      try {
        s4.muted = false;
        s4.play().catch(() => {});
      } catch (e) {}
    }, 600); // after fade-out
  }, 200); // how long YOU and image stay before fading
}

</script>

</body>
</html>


